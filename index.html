<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Bounce Dash</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
  html, body {
    margin: 0; padding: 0; overflow: hidden;
    background: #87ceeb;
    font-family: 'Press Start 2P', monospace;
    user-select: none;
  }
  #gameCanvas {
    background: linear-gradient(to top, #4caf50 0%, #a5d6a7 100%);
    display: block;
    margin: 0 auto;
    border: 4px solid #333;
    image-rendering: pixelated;
  }
  #ui {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none;
  }
  .btn {
    pointer-events: auto;
    position: fixed;
    bottom: 20px;
    width: 60px; height: 60px;
    font-size: 30px;
    border-radius: 12px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  #leftBtn { left: 20px; }
  #rightBtn { left: 100px; }
  #jumpBtn { right: 20px; }
  #levelSelect {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    color: white;
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 14px;
    user-select: none;
    pointer-events: auto;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  #worldArrowLeft, #worldArrowRight {
    cursor: pointer;
    font-size: 24px;
    user-select: none;
  }
  #levelButtons {
    display: flex;
    gap: 6px;
    flex-wrap: nowrap;
    max-width: 350px;
    overflow-x: auto;
  }
  #levelButtons button {
    background: #2e7d32;
    border: 2px solid #1b5e20;
    color: white;
    padding: 6px 10px;
    border-radius: 8px;
    font-family: 'Press Start 2P', monospace;
    font-size: 12px;
    cursor: pointer;
  }
  #levelButtons button.locked {
    background: #555;
    border-color: #333;
    cursor: default;
  }
  #coinsDisplay {
    position: fixed;
    top: 12px;
    right: 20px;
    background: rgba(0,0,0,0.6);
    color: white;
    padding: 8px 14px;
    font-family: 'Press Start 2P', monospace;
    font-size: 16px;
    border-radius: 12px;
    pointer-events: none;
    user-select: none;
  }
  #skinBuyContainer {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.6);
    color: white;
    border-radius: 12px;
    padding: 10px 20px;
    font-family: 'Press Start 2P', monospace;
    font-size: 14px;
    display: flex;
    gap: 20px;
    pointer-events: auto;
    user-select: none;
  }
  #skinBuyContainer button {
    background: #1976d2;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    color: white;
    font-weight: bold;
  }
  #deathPopup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(30,30,30,0.95);
    color: #eee;
    font-family: 'Press Start 2P', monospace;
    font-size: 20px;
    padding: 20px 30px;
    border-radius: 20px;
    text-align: center;
    display: none;
    z-index: 9999;
    user-select: none;
  }
  #deathPopup button {
    margin-top: 16px;
    background: #d32f2f;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 12px;
    font-family: 'Press Start 2P', monospace;
    font-size: 16px;
    cursor: pointer;
  }
</style>
</head>
<body>

<canvas id="gameCanvas" width="800" height="450"></canvas>

<div id="ui">
  <button id="leftBtn" class="btn" ontouchstart="keys.left=true" ontouchend="keys.left=false">←</button>
  <button id="rightBtn" class="btn" ontouchstart="keys.right=true" ontouchend="keys.right=false">→</button>
  <button id="jumpBtn" class="btn" ontouchstart="jump()" ontouchend="">⬆</button>

  <div id="levelSelect">
    <span id="worldArrowLeft" title="Previous World" onclick="switchWorld(-1)">◀</span>
    <span id="worldName">Grassland</span>
    <span id="worldArrowRight" title="Next World" onclick="switchWorld(1)">▶</span>
    <div id="levelButtons"></div>
  </div>

  <div id="coinsDisplay">Coins: 0</div>

  <div id="skinBuyContainer" style="display:none;">
    <div>Buy Ball Skin:</div>
    <button id="buyRedBtn">Red (100 coins)</button>
    <button id="buyGreenBtn">Green (200 coins)</button>
  </div>

  <div id="deathPopup">
    You Died!<br />
    <button onclick="resetLevel()">Reset Level</button>
  </div>
</div>

<script>
  // Canvas setup
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  // Controls
  const keys = { left:false, right:false, jump:false };

  // Game variables
  const GRAVITY = 0.6;
  const JUMP_VELOCITY = -12;
  const MOVE_SPEED = 4;

  // Player
  const player = {
    x: 100,
    y: 0,
    radius: 15,
    vx: 0,
    vy: 0,
    onGround: false,
  };

  // Worlds and levels data
  const worlds = [
    { name: 'Grassland', colorBg: '#87ceeb', colorGround: '#4caf50' },
    { name: 'Factory', colorBg: '#8a8a8a', colorGround: '#555555' },
    { name: 'Cave', colorBg: '#222222', colorGround: '#444444' },
    { name: 'Space', colorBg: '#001a33', colorGround: '#003366' },
  ];

  // Level structure: platforms, spikes, coins, enemies, flag
  // Coordinates are relative to canvas size
  // Example platform: {x, y, width, height}
  // Spikes are rectangles the player dies on touch
  // Coins are circles to collect
  // Enemies are rectangles with simple left/right patrol
  // Flag is rectangle to finish level

  // Each world has 10 levels (you can add more)
  // For brevity, here are 2 sample levels per world

  const levels = {
    Grassland: [
      {
        platforms: [
          {x:0, y:400, width:800, height:50},
          {x:150, y:340, width:120, height:20},
          {x:320, y:290, width:100, height:20},
          {x:500, y:340, width:120, height:20},
          {x:650, y:290, width:120, height:20}
        ],
        spikes: [
          {x:430, y:430, width:40, height:20}
        ],
        coins: [
          {x:200, y:300, radius:10},
          {x:530, y:300, radius:10},
          {x:680, y:250, radius:10}
        ],
        enemies: [
          {x:300, y:375, width:30, height:25, dir:1, speed:2, startX:300, endX:400}
        ],
        flag: {x:750, y:350, width:30, height:50}
      },
      {
        platforms: [
          {x:0, y:400, width:800, height:50},
          {x:120, y:350, width:100, height:20},
          {x:280, y:310, width:80, height:20},
          {x:420, y:270, width:90, height:20},
          {x:570, y:330, width:100, height:20},
          {x:700, y:290, width:70, height:20}
        ],
        spikes: [
          {x:200, y:430, width:50, height:20},
          {x:600, y:430, width:50, height:20}
        ],
        coins: [
          {x:150, y:320, radius:10},
          {x:300, y:270, radius:10},
          {x:720, y:250, radius:10}
        ],
        enemies: [
          {x:400, y:375, width:25, height:25, dir:-1, speed:1.5, startX:350, endX:450},
          {x:650, y:375, width:25, height:25, dir:1, speed:2, startX:650, endX:730}
        ],
        flag: {x:750, y:350, width:30, height:50}
      },
      // Add 8 more Grassland levels here...
    ],
    Factory: [
      {
        platforms: [
          {x:0, y:400, width:800, height:50},
          {x:100, y:350, width:120, height:20},
          {x:300, y:300, width:140, height:20},
          {x:520, y:340, width:130, height:20}
        ],
        spikes: [
          {x:250, y:430, width:40, height:20},
          {x:470, y:430, width:40, height:20}
        ],
        coins: [
          {x:140, y:320, radius:10},
          {x:350, y:270, radius:10},
          {x:540, y:300, radius:10}
        ],
        enemies: [
          {x:180, y:375, width:30, height:25, dir:1, speed:2, startX:180, endX:280}
        ],
        flag: {x:750, y:350, width:30, height:50}
      },
      {
        platforms: [
          {x:0, y:400, width:800, height:50},
          {x:220, y:350, width:100, height:20},
          {x:400, y:310, width:80, height:20},
          {x:550, y:270, width:110, height:20}
        ],
        spikes: [
          {x:370, y:430, width:40, height:20}
        ],
        coins: [
          {x:250, y:320, radius:10},
          {x:450, y:270, radius:10},
          {x:600, y:250, radius:10}
        ],
        enemies: [],
        flag: {x:750, y:350, width:30, height:50}
      },
      // Add 8 more Factory levels here...
    ],
    Cave: [
      {
        platforms: [
          {x:0, y:400, width:800, height:50},
          {x:100, y:360, width:90, height:20},
          {x:250, y:320, width:100, height:20},
          {x:420, y:290, width:110, height:20},
          {x:600, y:350, width:90, height:20}
        ],
        spikes: [
          {x:180, y:430, width:50, height:20},
          {x:480, y:430, width:40, height:20}
        ],
        coins: [
          {x:130, y:330, radius:10},
          {x:300, y:280, radius:10},
          {x:640, y:320, radius:10}
        ],
        enemies: [
          {x:350, y:375, width:30, height:25, dir:-1, speed:1.8, startX:300, endX:400}
        ],
        flag: {x:750, y:350, width:30, height:50}
      },
      {
        platforms: [
          {x:0, y:400, width:800, height:50},
          {x:160, y:340, width:80, height:20},
          {x:320, y:300, width:90, height:20},
          {x:520, y:270, width:110, height:20}
        ],
        spikes: [
          {x:210, y:430, width:40, height:20},
          {x:530, y:430, width:40, height:20}
        ],
        coins: [
          {x:180, y:310, radius:10},
          {x:350, y:260, radius:10},
          {x:600, y:280, radius:10}
        ],
        enemies: [
          {x:250, y:375, width:25, height:25, dir:1, speed:2, startX:250, endX:320}
        ],
        flag: {x:750, y:350, width:30, height:50}
      },
      // Add 8 more Cave levels here...
    ],
    Space: [
      {
        platforms: [
          {x:0, y:400, width:800, height:50},
          {x:120, y:350, width:130, height:20},
          {x:340, y:320, width:140, height:20},
          {x:600, y:280, width:120, height:20}
        ],
        spikes: [
          {x:200, y:430, width:50, height:20},
          {x:500, y:430, width:50, height:20}
        ],
        coins: [
          {x:150, y:320, radius:10},
          {x:380, y:290, radius:10},
          {x:650, y:250, radius:10}
        ],
        enemies: [
          {x:450, y:375, width:25, height:25, dir:1, speed:2, startX:450, endX:550}
        ],
        flag: {x:750, y:350, width:30, height:50}
      },
      {
        platforms: [
          {x:0, y:400, width:800, height:50},
          {x:210, y:360, width:110, height:20},
          {x:410, y:320, width:90, height:20},
          {x:600, y:280, width:100, height:20}
        ],
        spikes: [
          {x:300, y:430, width:40, height:20}
        ],
        coins: [
          {x:220, y:330, radius:10},
          {x:420, y:280, radius:10},
          {x:650, y:260, radius:10}
        ],
        enemies: [],
        flag: {x:750, y:350, width:30, height:50}
      },
      // Add 8 more Space levels here...
    ],
  };

  // Save and load keys
  const STORAGE_KEYS = {
    coins: 'bd_coins',
    unlockedLevels: 'bd_unlockedLevels', // stored as JSON: { Grassland: 2, Factory: 0, ... }
    currentSkin: 'bd_currentSkin',
    ownedSkins: 'bd_ownedSkins'
  };

  // Game state variables
  let coins = parseInt(localStorage.getItem(STORAGE_KEYS.coins)) || 0;
  let unlockedLevels = JSON.parse(localStorage.getItem(STORAGE_KEYS.unlockedLevels)) || {
    Grassland: 1,
    Factory: 0,
    Cave: 0,
    Space: 0
  };
  let currentWorldIndex = 0;
  let currentLevelIndex = 0;
  let currentSkin = localStorage.getItem(STORAGE_KEYS.currentSkin) || 'blue';
  let ownedSkins = JSON.parse(localStorage.getItem(STORAGE_KEYS.ownedSkins) || '["blue"]');

  const skins = {
    blue: '#2196f3',
    red: '#f44336',
    green: '#4caf50'
  };

  // UI Elements
  const coinsDisplay = document.getElementById('coinsDisplay');
  const worldNameElem = document.getElementById('worldName');
  const levelButtonsContainer = document.getElementById('levelButtons');
  const skinBuyContainer = document.getElementById('skinBuyContainer');
  const buyRedBtn = document.getElementById('buyRedBtn');
  const buyGreenBtn = document.getElementById('buyGreenBtn');
  const deathPopup = document.getElementById('deathPopup');

  // Update UI
  function updateCoinsUI() {
    coinsDisplay.textContent = 'Coins: ' + coins;
  }

  function saveProgress() {
    localStorage.setItem(STORAGE_KEYS.coins, coins);
    localStorage.setItem(STORAGE_KEYS.unlockedLevels, JSON.stringify(unlockedLevels));
    localStorage.setItem(STORAGE_KEYS.currentSkin, currentSkin);
    localStorage.setItem(STORAGE_KEYS.ownedSkins, JSON.stringify(ownedSkins));
  }

  // Level selection UI
  function buildLevelButtons() {
    levelButtonsContainer.innerHTML = '';
    const worldName = worlds[currentWorldIndex].name;
    const maxUnlocked = unlockedLevels[worldName] || 0;
    for(let i=0; i < levels[worldName].length; i++) {
      const btn = document.createElement('button');
      btn.textContent = 'Level ' + (i+1);
      if(i >= maxUnlocked) {
        btn.classList.add('locked');
        btn.disabled = true;
      } else {
        btn.disabled = false;
        btn.onclick = () => {
          currentLevelIndex = i;
          startLevel();
        }
      }
      levelButtonsContainer.appendChild(btn);
    }
  }

  function updateWorldUI() {
    worldNameElem.textContent = worlds[currentWorldIndex].name;
    buildLevelButtons();
    updateSkinButtons();
  }

  // Switch worlds with arrows
  function switchWorld(dir) {
    currentWorldIndex += dir;
    if(currentWorldIndex < 0) currentWorldIndex = worlds.length -1;
    if(currentWorldIndex >= worlds.length) currentWorldIndex = 0;
    currentLevelIndex = 0;
    updateWorldUI();
  }

  // Skin buying UI
  function updateSkinButtons() {
    skinBuyContainer.style.display = 'none';
    if(currentWorldIndex === 0 && currentLevelIndex === 0) {
      // Only show skins on first level of Grassland for demo
      skinBuyContainer.style.display = 'flex';
      buyRedBtn.disabled = ownedSkins.includes('red') || coins < 100;
      buyGreenBtn.disabled = ownedSkins.includes('green') || coins < 200;
    }
  }

  buyRedBtn.onclick = () => {
    if(coins >= 100 && !ownedSkins.includes('red')) {
      coins -= 100;
      ownedSkins.push('red');
      currentSkin = 'red';
      saveProgress();
      updateCoinsUI();
      updateSkinButtons();
    }
  };

  buyGreenBtn.onclick = () => {
    if(coins >= 200 && !ownedSkins.includes('green')) {
      coins -= 200;
      ownedSkins.push('green');
      currentSkin = 'green';
      saveProgress();
      updateCoinsUI();
      updateSkinButtons();
    }
  };

  // Player physics and collision helper functions
  function rectsOverlap(r1, r2) {
    return !(r2.x > r1.x + r1.width || 
             r2.x + r2.width < r1.x || 
             r2.y > r1.y + r1.height ||
             r2.y + r2.height < r1.y);
  }

  function circleRectColliding(circle, rect) {
    // Find closest point to circle center on rect
    const closestX = Math.max(rect.x, Math.min(circle.x, rect.x + rect.width));
    const closestY = Math.max(rect.y, Math.min(circle.y, rect.y + rect.height));
    const dx = circle.x - closestX;
    const dy = circle.y - closestY;
    return (dx*dx + dy*dy) < (circle.radius * circle.radius);
  }

  // Game state
  let levelData = null;

  function startLevel() {
    deathPopup.style.display = 'none';
    player.x = 100;
    player.y = 350;
    player.vx = 0;
    player.vy = 0;
    player.onGround = false;
    levelData = levels[worlds[currentWorldIndex].name][currentLevelIndex];
    updateCoinsUI();
    updateSkinButtons();
  }

  // Movement & input
  document.addEventListener('keydown', e => {
    if(e.code === 'ArrowLeft') keys.left = true;
    else if(e.code === 'ArrowRight') keys.right = true;
    else if(e.code === 'Space') jump();
  });
  document.addEventListener('keyup', e => {
    if(e.code === 'ArrowLeft') keys.left = false;
    else if(e.code === 'ArrowRight') keys.right = false;
  });

  document.getElementById('leftBtn').addEventListener('mousedown', () => keys.left = true);
  document.getElementById('leftBtn').addEventListener('mouseup', () => keys.left = false);
  document.getElementById('leftBtn').addEventListener('touchstart', e => { e.preventDefault(); keys.left = true; });
  document.getElementById('leftBtn').addEventListener('touchend', e => { e.preventDefault(); keys.left = false; });

  document.getElementById('rightBtn').addEventListener('mousedown', () => keys.right = true);
  document.getElementById('rightBtn').addEventListener('mouseup', () => keys.right = false);
  document.getElementById('rightBtn').addEventListener('touchstart', e => { e.preventDefault(); keys.right = true; });
  document.getElementById('rightBtn').addEventListener('touchend', e => { e.preventDefault(); keys.right = false; });

  document.getElementById('jumpBtn').addEventListener('click', jump);
  document.getElementById('jumpBtn').addEventListener('touchstart', e => { e.preventDefault(); jump(); });

  function jump() {
    if(player.onGround) {
      player.vy = JUMP_VELOCITY;
      player.onGround = false;
    }
  }

  // Game update & draw loop
  function update() {
    // Horizontal move
    player.vx = 0;
    if(keys.left) player.vx = -MOVE_SPEED;
    if(keys.right) player.vx = MOVE_SPEED;

    player.x += player.vx;
    player.vy += GRAVITY;
    player.y += player.vy;

    // Check collisions with platforms
    player.onGround = false;
    for(const p of levelData.platforms) {
      // AABB collision check for platform top only (simple)
      if(player.x + player.radius > p.x && player.x - player.radius < p.x + p.width) {
        if(player.y + player.radius > p.y && player.y + player.radius < p.y + p.height) {
          // Player landed on platform top
          player.y = p.y - player.radius;
          player.vy = 0;
          player.onGround = true;
        }
      }
    }

    // Keep player inside screen horizontally
    if(player.x - player.radius < 0) player.x = player.radius;
    if(player.x + player.radius > canvas.width) player.x = canvas.width - player.radius;

    // Death by falling below canvas
    if(player.y - player.radius > canvas.height) {
      showDeathPopup();
    }

    // Death by spikes
    for(const s of levelData.spikes) {
      if(circleRectColliding(player, s)) {
        showDeathPopup();
      }
    }

    // Enemy movement and collision
    for(const e of levelData.enemies) {
      e.x += e.speed * e.dir;
      if(e.x < e.startX) e.dir = 1;
      else if(e.x + e.width > e.endX) e.dir = -1;

      // Check collision with player
      const enemyRect = {x:e.x, y:e.y, width:e.width, height:e.height};
      if(circleRectColliding(player, enemyRect)) {
        if(player.vy > 0 && player.y + player.radius - player.vy <= e.y) {
          // Player jumped on enemy - kill enemy
          levelData.enemies = levelData.enemies.filter(en => en !== e);
          player.vy = JUMP_VELOCITY / 2; // bounce up
          coins += 5;
          saveProgress();
          updateCoinsUI();
          break;
        } else {
          // Player hit enemy from side - die
          showDeathPopup();
          break;
        }
      }
    }

    // Coin collection
    for(let i = levelData.coins.length - 1; i >= 0; i--) {
      const c = levelData.coins[i];
      const dx = player.x - c.x;
      const dy = player.y - c.y;
      if(dx*dx + dy*dy < (player.radius + c.radius) ** 2) {
        levelData.coins.splice(i, 1);
        coins += 1;
        saveProgress();
        updateCoinsUI();
      }
    }

    // Flag check to complete level
    const flag = levelData.flag;
    const flagRect = {x:flag.x, y:flag.y, width:flag.width, height:flag.height};
    if(rectsOverlap({x:player.x - player.radius, y:player.y - player.radius, width:player.radius*2, height:player.radius*2}, flagRect)) {
      completeLevel();
    }
  }

  function completeLevel() {
    // Unlock next level
    const worldName = worlds[currentWorldIndex].name;
    if(unlockedLevels[worldName] <= currentLevelIndex) {
      unlockedLevels[worldName] = currentLevelIndex + 1;
      saveProgress();
    }
    // Auto switch to next level if unlocked, else stay
    if(currentLevelIndex + 1 < levels[worldName].length && unlockedLevels[worldName] > currentLevelIndex + 1) {
      currentLevelIndex++;
      startLevel();
    } else {
      alert('Level Complete! No more unlocked levels in this world. Switch world or replay.');
    }
    updateWorldUI();
  }

  function showDeathPopup() {
    deathPopup.style.display = 'block';
  }

  function resetLevel() {
    deathPopup.style.display = 'none';
    startLevel();
  }

  // Drawing functions
  function draw() {
    // Clear bg
    ctx.fillStyle = worlds[currentWorldIndex].colorBg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw ground platforms
    ctx.fillStyle = worlds[currentWorldIndex].colorGround;
    for(const p of levelData.platforms) {
      ctx.fillRect(p.x, p.y, p.width, p.height);
    }

    // Draw spikes
    ctx.fillStyle = '#b71c1c';
    for(const s of levelData.spikes) {
      ctx.beginPath();
      // spikes as triangles
      const spikeCount = Math.floor(s.width / 20);
      for(let i=0; i<spikeCount; i++) {
        const sx = s.x + i*20;
        ctx.moveTo(sx, s.y + s.height);
        ctx.lineTo(sx + 10, s.y);
        ctx.lineTo(sx + 20, s.y + s.height);
      }
      ctx.fill();
    }

    // Draw coins
    ctx.fillStyle = 'gold';
    for(const c of levelData.coins) {
      ctx.beginPath();
      ctx.arc(c.x, c.y, c.radius, 0, Math.PI*2);
      ctx.fill();
      // coin shine
      ctx.strokeStyle = 'rgba(255,255,255,0.8)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(c.x - 3, c.y - 3, c.radius/2, 0, Math.PI*2);
      ctx.stroke();
    }

    // Draw enemies
    ctx.fillStyle = '#ff5722';
    for(const e of levelData.enemies) {
      ctx.fillRect(e.x, e.y, e.width, e.height);
    }

    // Draw flag
    ctx.fillStyle = '#fbc02d';
    const f = levelData.flag;
    ctx.fillRect(f.x, f.y, f.width, f.height);

    // Draw player ball with current skin
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2);
    ctx.fillStyle = skins[currentSkin] || 'blue';
    ctx.fill();
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 3;
    ctx.stroke();
  }

  // Main loop
  function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
  }

  // Init
  updateCoinsUI();
  updateWorldUI();
  startLevel();
  loop();

  // Expose functions for HTML
  window.switchWorld = switchWorld;
  window.resetLevel = resetLevel;

</script>

</body>
</html>
